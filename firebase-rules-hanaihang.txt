rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // กฎสำหรับข้อมูลห้างสรรพสินค้า
    match /malls/{mallId} {
      allow read: if true; // ให้อ่านได้ทุกคน
      allow write: if request.auth != null; // เขียนได้เฉพาะผู้ใช้ที่ login
      
      // ตรวจสอบข้อมูลที่จำเป็น
      allow create: if request.auth != null 
        && request.resource.data.keys().hasAll(['name', 'location', 'stores'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.location is map
        && request.resource.data.location.keys().hasAll(['lat', 'lng', 'address'])
        && request.resource.data.location.lat is number
        && request.resource.data.location.lat >= -90
        && request.resource.data.location.lat <= 90
        && request.resource.data.location.lng is number
        && request.resource.data.location.lng >= -180
        && request.resource.data.location.lng <= 180
        && request.resource.data.location.address is string
        && request.resource.data.location.address.size() > 0;
        
      allow update: if request.auth != null
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0;
    }
    
    // กฎสำหรับข้อมูลร้านค้า
    match /stores/{storeId} {
      allow read: if true; // ให้อ่านได้ทุกคน
      allow write: if request.auth != null; // เขียนได้เฉพาะผู้ใช้ที่ login
      
      // ตรวจสอบข้อมูลที่จำเป็น
      allow create: if request.auth != null
        && request.resource.data.keys().hasAll(['name', 'category', 'mallId'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.category is string
        && request.resource.data.category.size() > 0
        && request.resource.data.mallId is string
        && request.resource.data.mallId.size() > 0;
        
      allow update: if request.auth != null
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0;
    }
    
    // กฎสำหรับข้อมูลผู้ใช้ Admin
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // ตรวจสอบข้อมูลผู้ใช้
      allow create: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.data.email is string
        && request.resource.data.email.matches('.*@.*\\..*')
        && request.resource.data.role is string
        && request.resource.data.role in ['admin', 'user'];
    }
    
    // กฎสำหรับข้อมูลการค้นหา (Analytics)
    match /searchLogs/{logId} {
      allow read: if request.auth != null; // อ่านได้เฉพาะผู้ใช้ที่ login
      allow write: if true; // เขียนได้ทุกคน (สำหรับเก็บ search logs)
      
      // ตรวจสอบข้อมูล search log
      allow create: if request.resource.data.keys().hasAll(['query', 'timestamp', 'location'])
        && request.resource.data.query is string
        && request.resource.data.query.size() > 0
        && request.resource.data.timestamp is number
        && request.resource.data.location is map
        && request.resource.data.location.keys().hasAll(['lat', 'lng'])
        && request.resource.data.location.lat is number
        && request.resource.data.location.lat >= -90
        && request.resource.data.location.lat <= 90
        && request.resource.data.location.lng is number
        && request.resource.data.location.lng >= -180
        && request.resource.data.location.lng <= 180;
    }
    
    // กฎสำหรับข้อมูลการตั้งค่าแอป
    match /appSettings/{settingId} {
      allow read: if true; // อ่านได้ทุกคน
      allow write: if request.auth != null; // เขียนได้เฉพาะผู้ใช้ที่ login
      
      // ตรวจสอบข้อมูลการตั้งค่า
      allow create: if request.auth != null
        && request.resource.data.version is string
        && request.resource.data.maintenance is bool;
    }
  }
}
